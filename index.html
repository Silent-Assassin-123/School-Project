<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            background-size: 400% 400%; /* For animated gradient */
            animation: gradientBackground 15s ease infinite;
        }

        /* Animated Gradient Background */
        @keyframes gradientBackground {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Light mode defaults (now purple-tinted) */
        .light-mode {
            background-image: linear-gradient(225deg, #e1bee7, #ce93d8, #e0b0e9, #f3e5f5); /* Lighter purples */
            color: #1A1A1D; /* Near black text */
        }
        .light-mode .bg-white {
            background-color: #ffffff;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 15px -5px rgba(0, 0, 0, 0.04); /* Deeper shadow */
            border: 1px solid rgba(229, 231, 235, 0.7); /* Lighter border */
        }
        .light-mode .text-gray-600 { color: #4A148C; } /* Purple for main text */
        .light-mode .text-gray-500 { color: #6A1B9A; } /* Medium purple for hints */
        .light-mode .text-gray-900 { color: #1A1A1D; } /* Primary text color (near black) */
        .light-mode .text-gray-700 { color: #3E2723; } /* Darker text for labels etc. (warm hint) */
        .light-mode .border-gray-200 { border-color: #E1BEE7; } /* Light purple border */
        .light-mode .bg-gray-50 {
            background-color: #F3E5F5; /* Very light purple/pinkish */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); /* Subtle shadow for list items */
        }
        .light-mode .hover\:bg-gray-100:hover { background-color: #EDE7F6; } /* Slightly darker light purple */
        .light-mode .border-gray-300 { border-color: #CE93D8; } /* Medium purple border */
        .light-mode input, .light-mode select { background-color: #ffffff; color: #1A1A1D; border-color: #CE93D8; }


        /* Dark mode styles (black and purple dominant) */
        .dark-mode {
            background-image: linear-gradient(225deg, #1A1A1D, #212121, #2C2C30, #3E2723); /* Black/dark grey with slight warm hint */
            color: #E1BEE7; /* Light purple text */
        }
        .dark-mode .bg-white {
            background-color: #2C2C30; /* Dark grey for cards */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 5px 15px -5px rgba(0, 0, 0, 0.1); /* Deeper shadow for dark mode */
            border: 1px solid #4A148C; /* Deep purple border */
        }
        .dark-mode .text-gray-600 { color: #CE93D8; } /* Medium-light purple */
        .dark-mode .text-gray-500 { color: #E1BEE7; } /* Light purple for hints */
        .dark-mode .text-gray-900 { color: #E1BEE7; } /* Primary text color (light purple) */
        .dark-mode .text-gray-700 { color: #D7CCC8; } /* Lighter grey for labels (warm hint) */
        .dark-mode .border-gray-200 { border-color: #4A148C; } /* Deep purple border */
        .dark-mode .bg-gray-50 {
            background-color: #3E2723; /* Darker brown-grey for list items */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.08);
        }
        .dark-mode .hover\:bg-gray-100:hover { background-color: #4A302A; } /* Slightly darker brown-grey */
        .dark-mode .border-gray-300 { border-color: #6A1B9A; } /* Medium purple border */
        .dark-mode input, .dark-mode select { background-color: #4A148C; color: #E1BEE7; border-color: #6A1B9A; }
        .dark-mode input.focus\:border-indigo-500:focus,
        .dark-mode input.focus\:ring-indigo-500:focus {
            border-color: #9C27B0 !important;
            box-shadow: 0 0 0 3px rgba(156, 39, 176, 0.4) !important;
        }

        /* Enhanced Button Styling */
        .btn-primary {
            background: linear-gradient(to right, #6A1B9A, #9C27B0); /* Medium to vibrant purple */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(106, 27, 154, 0.4);
        }
        .btn-primary:hover {
            background: linear-gradient(to right, #4A148C, #6A1B9A); /* Deeper purple on hover */
            box-shadow: 0 6px 15px rgba(106, 27, 154, 0.5);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #ffffff;
            color: #4A148C; /* Deep purple text */
            border: 1px solid #9C27B0; /* Vibrant purple border */
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .btn-secondary:hover {
            background-color: #F3E5F5; /* Light purple hover */
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .dark-mode .btn-secondary {
            background-color: #1A1A1D; /* Near black */
            color: #E1BEE7; /* Light purple text */
            border-color: #4A148C; /* Deep purple border */
        }
        .dark-mode .btn-secondary:hover {
            background-color: #2C2C30; /* Dark grey hover */
        }


        .btn-green { /* Used for 'Available' books, now a vibrant green for contrast */
            background: linear-gradient(to right, #50C878, #36B368);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(52, 211, 153, 0.3);
        }
        .btn-green:hover {
            background: linear-gradient(to right, #36B368, #239A5D);
            box-shadow: 0 6px 15px rgba(52, 211, 153, 0.4);
            transform: translateY(-1px);
        }

        .btn-yellow { /* Used for 'Borrowed' books, now a prominent red hint */
            background: linear-gradient(to right, #D32F2F, #B71C1C); /* Darker Red */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(211, 47, 47, 0.4);
        }
        .btn-yellow:hover {
            background: linear-gradient(to right, #B71C1C, #8F0000);
            box-shadow: 0 6px 15px rgba(211, 47, 47, 0.5);
            transform: translateY(-1px);
        }

        .btn-red { /* Used for Logout/Delete - kept as strong red */
            background: linear-gradient(to right, #ef4444, #dc2626);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }
        .btn-red:hover {
            background: linear-gradient(to right, #dc2626, #b91c1c);
            box-shadow: 0 6px 15px rgba(239, 68, 68, 0.4);
            transform: translateY(-1px);
        }

        .btn-blue { /* Used for Edit button, now a blue-purple */
            background: linear-gradient(to right, #673AB7, #5E35B1); /* Deep Purple-Blue */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(103, 58, 183, 0.3);
        }
        .btn-blue:hover {
            background: linear-gradient(to right, #5E35B1, #4527A0);
            box-shadow: 0 6px 15px rgba(103, 58, 183, 0.4);
            transform: translateY(-1px);
        }

        .btn-purple { /* Used for Fetch Details, now a distinct purple */
            background: linear-gradient(to right, #8E24AA, #7B1FA2); /* Vibrant Purple */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(142, 36, 170, 0.3);
        }
        .btn-purple:hover {
            background: linear-gradient(to right, #7B1FA2, #6A1B9A);
            box-shadow: 0 6px 15px rgba(142, 36, 170, 0.4);
            transform: translateY(-1px);
        }

        /* Enhanced list item hover effect */
        .book-list-item {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .book-list-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px -5px rgba(0, 0, 0, 0.15), 0 4px 10px -5px rgba(0, 0, 0, 0.08);
        }
        .dark-mode .book-list-item:hover {
            box-shadow: 0 8px 20px -5px rgba(0, 0, 0, 0.3), 0 4px 10px -5px rgba(0, 0, 0, 0.15);
        }

        /* Adjust input focus styles for better contrast */
        input:focus {
            outline: none;
            border-color: #9C27B0 !important; /* Vibrant purple */
            box-shadow: 0 0 0 3px rgba(156, 39, 176, 0.4) !important; /* Vibrant purple with opacity */
        }
        .dark-mode input:focus {
            border-color: #E1BEE7 !important; /* Light purple */
            box-shadow: 0 0 0 3px rgba(225, 190, 231, 0.4) !important; /* Light purple with opacity */
        }

        /* Ensure heading colors are affected by theme */
        .text-header-light { color: #4A148C; /* Deep purple */ }
        .text-header-dark { color: #E1BEE7; /* Light purple */ }

        .text-sub-header-light { color: #6A1B9A; /* Medium purple */ }
        .text-sub-header-dark { color: #CE93D8; /* Medium-light purple */ }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6A1B9A; /* Purple */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for the loading container */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh; /* Ensure it takes full viewport height */
            text-align: center;
            color: #4A148C; /* Deep purple text */
            background-image: linear-gradient(225deg, #e1bee7, #ce93d8, #e0b0e9, #f3e5f5); /* Light mode gradient */
            background-size: 400% 400%;
            animation: gradientBackground 15s ease infinite;
            z-index: 1000; /* Ensure it's on top */
            position: fixed; /* Fix it to the viewport */
            top: 0; left: 0; right: 0; bottom: 0;
        }
        .dark-mode .loading-container {
            color: #E1BEE7; /* Light purple text in dark mode */
            background-image: linear-gradient(225deg, #1A1A1D, #212121, #2C2C30, #3E2723); /* Dark mode gradient */
        }

        /* Tab specific styles from family-library-final (adjusted for theme) */
        .tab-active { background-color: #6A1B9A; color: white; } /* Deep purple for active tab */
        .dark-mode .tab-active { background-color: #4A148C; color: #E1BEE7; } /* Darker purple for active tab in dark mode */
        .tab-btn {
            padding: 8px 16px;
            border-radius: 6px;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-weight: 500;
        }
        .light-mode .tab-btn {
            background-color: transparent;
            color: #6A1B9A; /* Medium purple text */
        }
        .light-mode .tab-btn:hover:not(.tab-active) {
            background-color: #F3E5F5; /* Very light purple/pinkish */
        }
        .dark-mode .tab-btn {
            background-color: transparent;
            color: #CE93D8; /* Medium-light purple */
        }
        .dark-mode .tab-btn:hover:not(.tab-active) {
            background-color: #3E2723; /* Darker brown-grey */
        }
    </style>
</head>
<body class="light-mode">
    <div id="app" class="min-h-screen p-4">
        <div id="initial-loading-screen" class="loading-container">
            <div class="spinner mb-4"></div>
            <p id="loading-message" class="text-xl animate-pulse">Loading library...</p>
        </div>

        <div id="main-content" class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg my-8 hidden">
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-extrabold text-header-light">School Library</h1>
                <div class="flex items-center gap-4">
                    <div id="user-info" class="text-sm text-gray-700"></div>
                    <button id="toggle-theme" class="px-3 py-1 rounded-full text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-opacity-75
                        bg-gray-200 text-gray-800 hover:bg-gray-300
                        dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
                        Toggle Theme
                    </button>
                    <button id="logout-btn" class="btn-red text-sm py-1 px-3 rounded-md">Logout</button>
                </div>
            </header>

            <nav class="mb-4 border-b border-gray-300">
                <ul class="flex space-x-4">
                    <li><button data-tab="home" class="tab-btn py-2 px-4 tab-active">Home</button></li>
                    <li><button data-tab="catalogue" class="tab-btn py-2 px-4">Catalogue</button></li>
                    <li><button data-tab="leaderboard" class="tab-btn py-2 px-4">Leaderboard</button></li>
                    <li><button data-tab="admin" class="tab-btn py-2 px-4 hidden" id="admin-tab">Manage Books</button></li>
                    <li><button data-tab="profile" class="tab-btn py-2 px-4">Profile</button></li>
                </ul>
            </nav>

            <div id="home" class="tab-panel">
                <h2 class="text-3xl font-extrabold text-header-light mb-4" id="home-greeting"></h2>
                <p class="text-gray-700 mb-6">Welcome to my School Library application! Here's a quick overview:</p>

                <div class="mb-8">
                    <h3 class="text-xl font-bold text-sub-header-light mb-3">Your Borrowed Books</h3>
                    <div id="your-borrowed-books-list" class="space-y-3">
                        <p class="text-gray-500" id="no-borrowed-books-message">You currently have no books borrowed.</p>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-xl font-bold text-sub-header-light mb-3">Recently Added Books</h3>
                    <div id="recently-added-books-list" class="space-y-3">
                        <p class="text-gray-500" id="no-recent-books-message">No recently added books to display.</p>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-bold text-sub-header-light mb-3">Library Statistics</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-gray-700">
                        <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                            <p class="text-sm text-gray-500">Total Books</p>
                            <p id="stat-total-books" class="text-2xl font-bold text-purple-700">0</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                            <p class="text-sm text-gray-500">Currently Borrowed</p>
                            <p id="stat-borrowed-books" class="text-2xl font-bold text-yellow-700">0</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                            <p class="text-sm text-gray-500">Books Available</p>
                            <p id="stat-available-books" class="text-2xl font-bold text-green-700">0</p>
                         </div>
                         <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                            <p class="text-sm text-gray-500">Unique Borrowers</p>
                            <p id="stat-unique-borrowers" class="text-2xl font-bold text-purple-700">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="catalogue" class="tab-panel hidden">
                <h2 class="text-2xl font-bold text-sub-header-light mb-4">Book Catalogue</h2>
                <input type="text" id="search-input" placeholder="Search by title or author..."
                    class="mb-4 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm
                    focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                <div id="books-list" class="space-y-3">
                    </div>
                <p id="no-books-message" class="text-gray-500 text-center mt-4 hidden">No books found.</p>
            </div>

            <div id="leaderboard" class="tab-panel hidden">
                <h2 class="text-2xl font-bold text-sub-header-light mb-4">Top Borrowers</h2>
                <ul id="leaderboard-list" class="list-disc list-inside text-gray-700 space-y-1">
                    <p class="text-gray-500 text-center mt-4" id="no-leaderboard-data-message">No borrowing data yet.</p>
                </ul>
            </div>

            <div id="admin" class="tab-panel hidden">
                <h2 id="add-edit-form-title" class="text-2xl font-bold text-sub-header-light mb-4">Add New Book</h2>
                <form id="add-edit-book-form" class="space-y-4 p-6 bg-gray-50 rounded-lg shadow-inner">
                    <div id="isbn-search-section">
                        <label for="isbn-search-input" class="block text-sm font-medium text-gray-700 mb-1">
                            ISBN (Optional for auto-fill)
                        </label>
                        <div class="flex space-x-2">
                            <input type="text" id="isbn-search-input" placeholder="Enter ISBN to auto-fill"
                                class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm
                                focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                            <button type="button" id="fetch-details-btn" class="btn-purple py-2 px-4 rounded-md font-semibold flex-shrink-0">
                                Fetch Details
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="book-title" class="block text-sm font-medium text-gray-700 mb-1">
                            Title <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="book-title" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm
                            focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div>
                        <label for="book-author" class="block text-sm font-medium text-gray-700 mb-1">
                            Author <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="book-author" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm
                            focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <input type="hidden" id="book-isbn">
                    <div class="flex space-x-2">
                        <button type="submit" id="add-update-button" class="btn-primary py-2 px-4 rounded-md font-semibold">
                            Add Book
                        </button>
                        <button type="button" id="cancel-edit-button" class="btn-secondary py-2 px-4 rounded-md font-semibold hidden">
                            Cancel Edit
                        </button>
                    </div>
                </form>

                <h3 class="text-xl font-bold text-sub-header-light mt-8 mb-4">Manage Existing Books</h3>
                <input type="text" id="admin-search-input" placeholder="Search books for administration..."
                    class="mb-4 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm
                    focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                <div id="admin-book-list" class="space-y-3">
                    </div>
                <p id="no-admin-books-message" class="text-gray-500 text-center mt-4 hidden">No books found for management.</p>
            </div>

            <div id="profile" class="tab-panel hidden">
                <h2 class="text-2xl font-bold text-sub-header-light mb-4">Your Profile</h2>
                <form id="profile-form" class="space-y-2 p-6 bg-gray-50 rounded-lg shadow-inner">
                    <div>
                        <label for="display-name-input" class="block text-sm font-medium text-gray-700 mb-1">Display Name:</label>
                        <input type="text" id="display-name-input" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Set your display name" />
                    </div>
                    <button type="submit" class="btn-primary py-2 px-4 rounded-md font-semibold">Save Profile</button>
                    <div id="profile-message" class="text-sm mt-2 text-green-600"></div>
                </form>
            </div>
        </div>
        <div id="auth-view" class="flex items-center justify-center min-h-screen hidden">
            <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-3xl font-bold text-center text-sub-header-light mb-6">
                    Welcome to School Library
                </h2>
                <form id="auth-form" class="space-y-4">
                    <div>
                        <label for="auth-email" class="block text-sm font-medium text-gray-700 mb-1">
                            Email
                        </label>
                        <input type="email" id="auth-email" class="mt-1 block w-full
                            px-3 py-2 border border-gray-300 rounded-md shadow-sm
                            focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div>
                        <label for="auth-password" class="block text-sm font-medium text-gray-700 mb-1">
                            Password
                        </label>
                        <input type="password" id="auth-password" class="mt-1 block w-full
                            px-3 py-2 border border-gray-300 rounded-md shadow-sm
                            focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <button type="submit" id="signin-btn" class="w-full btn-primary py-2 px-4 rounded-md text-white font-semibold">
                        Sign In
                    </button>
                    <button type="button" id="signup-btn" class="w-full btn-secondary py-2 px-4 rounded-md font-semibold mt-2">
                        Sign Up
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script type="module">
        // Initialize Supabase - REPLACE WITH YOUR ACTUAL KEYS
        const SUPABASE_URL = 'https://nhoozjzvkydxwlrshqis.supabase.co'; // Using key from Test.html
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ob296anp2a3lkeHdscnNocWlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NzMyNDEsImV4cCI6MjA2NjM0OTI0MX0.5PfsT7CBIBOIziR8k0FsMPZzW0z7EzVrzFaWvhOIK9M'; // Using key from Test.html

        // Ensure createClient is available from the global Supabase object
        let createClient;
        if (window.supabase && typeof window.supabase.createClient === 'function') {
            createClient = window.supabase.createClient;
            console.log("Supabase createClient found.");
        } else {
            console.error("Supabase SDK not loaded or createClient is not a function. Check CDN script.");
            // Display an immediate error on the loading screen if Supabase isn't ready
            document.getElementById('loading-message').textContent = "Fatal Error: Supabase SDK not found. Please check your internet connection or script tags.";
            const spinner = document.querySelector('#initial-loading-screen .spinner');
            if (spinner) spinner.style.borderColor = 'red';
            // Prevent further execution if SDK is missing
            throw new Error("Supabase SDK not initialized.");
        }

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let userId = null;
        let userEmail = null;
        let isAdmin = false;
        let books = [];
        let userProfiles = {}; // New: To store user_id -> display_name mapping
        let editingBook = null;

        const adminUids = [
            'ca6c353e-d022-4bef-b567-e02ecdbc552d', // anirudhrajesh04@gmail.com's UID
            '89c9470e-abfb-490e-9564-6d2c477d0c9e'  // anirudhrajesh999@gmail.com's UID
        ];

        // Main containers
        const appDiv = document.getElementById('app');
        const initialLoadingScreen = document.getElementById('initial-loading-screen');
        const loadingMessage = document.getElementById('loading-message');
        const mainContentDiv = document.getElementById('main-content');
        const authViewDiv = document.getElementById('auth-view');

        // Tab elements
        const tabs = document.querySelectorAll(".tab-btn");
        const panels = document.querySelectorAll(".tab-panel");
        const adminTab = document.getElementById('admin-tab');

        // --- Supabase Initialization ---
        async function initializeSupabase() {
            console.log("Initializing Supabase...");
            initialLoadingScreen.style.display = 'flex'; // Ensure loading screen is visible

            try {
                // Listen for auth state changes and render appropriate view
                supabase.auth.onAuthStateChange(async (event, session) => {
                    console.log("Auth state changed:", event, session ? session.user : 'No session');
                    try {
                        if (session && session.user) {
                            userId = session.user.id;
                            userEmail = session.user.email;
                            isAdmin = adminUids.includes(userId);
                            await fetchUserProfiles(); // Fetch profiles whenever auth state changes
                            renderMainAppContent(); // Show main app if logged in
                            console.log(`User ${userEmail} (${userId}) is ${isAdmin ? 'an Admin' : 'a Member'}.`);
                            setupRealtimeProfilesListener(); // NEW: Setup profile listener on login
                        } else {
                            userId = null;
                            userEmail = null;
                            isAdmin = false;
                            userProfiles = {}; // Clear profiles on logout
                            renderAuthView(); // Show login page if not logged in
                            console.log('User logged out or session invalid.');
                            if (window.currentRealtimeProfilesChannel) {
                                window.currentRealtimeProfilesChannel.unsubscribe(); // Unsubscribe on logout
                                window.currentRealtimeProfilesChannel = null;
                            }
                        }
                    } catch (innerError) {
                        console.error("Error in onAuthStateChange callback:", innerError);
                        loadingMessage.textContent = `Error: ${innerError.message}. Please refresh.`;
                        initialLoadingScreen.style.display = 'flex'; // Keep loading screen visible with error
                    } finally {
                        // Ensure loading screen is hidden *after* the view is fully rendered or an error is displayed.
                         if (initialLoadingScreen.style.display !== 'none') {
                             setTimeout(() => {
                                 initialLoadingScreen.style.display = 'none';
                                 console.log('Loading screen hidden by final fallback.');
                             }, 500); // Give a small delay to ensure content renders first
                         }
                    }
                    updateUserInfoDisplay(); // Update user info display immediately
                    setupRealtimeBooksListener(); // Re-setup listener on auth change (will remove existing channels)
                });

                // Initial check for existing session
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError) {
                    console.warn("Initial getUser check returned an error:", userError.message);
                }

                if (user) {
                    console.log("Existing user session found on initial load:", user.id);
                    userId = user.id;
                    userEmail = user.email;
                    isAdmin = adminUids.includes(userId);
                    await fetchUserProfiles(); // Fetch profiles on initial load if user exists
                    renderMainAppContent();
                    setupRealtimeProfilesListener(); // NEW: Setup profile listener on initial session
                } else {
                    console.log("No existing user session on initial load. Showing auth view.");
                    renderAuthView();
                }

            } catch (error) {
                console.error("Error during Supabase initialization:", error);
                loadingMessage.textContent = "Failed to load library: " + error.message;
                initialLoadingScreen.style.display = 'flex'; // Keep loading screen visible with error
            }
        }

        // --- Fetch User Profiles ---
        async function fetchUserProfiles() {
            if (!supabase) return;
            console.log("Fetching user profiles...");
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('user_id, display_name');

                if (error) {
                    // If no profiles table or RLS prevents read, don't throw, just log.
                    console.warn("Could not fetch user profiles (RLS issue or table not found):", error.message);
                    userProfiles = {}; // Ensure it's an empty object even on error
                    return;
                }

                userProfiles = {}; // Clear existing profiles
                data.forEach(profile => {
                    userProfiles[profile.user_id] = profile.display_name || profile.user_id; // Fallback to UID if no display name
                });
                console.log("Fetched user profiles:", userProfiles);
            } catch (error) {
                console.error("Error in fetchUserProfiles catch block:", error.message);
                userProfiles = {};
            }
        }

        // --- Real-time Profiles Listener ---
        function setupRealtimeProfilesListener() {
            if (!supabase) return;

            // Unsubscribe from any previous profile channel to prevent duplicates
            if (window.currentRealtimeProfilesChannel) {
                window.currentRealtimeProfilesChannel.unsubscribe();
                window.currentRealtimeProfilesChannel = null;
                console.log("Unsubscribed from previous profiles channel.");
            }

            console.log("Setting up real-time profiles listener.");
            window.currentRealtimeProfilesChannel = supabase
                .channel('profiles_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, payload => {
                    console.log('Real-time profile change received!', payload);
                    fetchUserProfiles().then(() => {
                        // After profiles are fetched, re-render all dependent UI parts
                        updateUserInfoDisplay();
                        renderBookList(); // Update catalogue to show new names
                        renderAdminBookList(); // Update admin list to show new names
                        renderLeaderboard(); // Update leaderboard with new names
                        renderHomePageContent(); // Update home page content with new names
                    });
                })
                .subscribe();
        }

        // --- Fetch Book Details from Supabase ---
        async function fetchAndRenderBooks() {
            if (!supabase) return;
            console.log("Fetching and rendering books...");
            try {
                const { data, error } = await supabase
                    .from('books')
                    .select(`
                        id,
                        title,
                        author,
                        isbn,
                        borrowed_by,
                        last_modified,
                        added_by
                    `);

                if (error) {
                    console.error("Error fetching books from Supabase:", error);
                    books = []; // Clear books on error
                    return; // Stop execution to prevent errors in render functions
                }

                books = data.map(book => {
                    // Use userProfiles map for display names
                    let displayBorrowedBy = userProfiles[book.borrowed_by] || book.borrowed_by || 'N/A';
                    let displayAddedBy = userProfiles[book.added_by] || book.added_by || 'Unknown';

                    return {
                        ...book,
                        displayBorrowedBy: displayBorrowedBy,
                        displayAddedBy: displayAddedBy
                    };
                }).sort((a, b) => a.title.localeCompare(b.title)); // Sort alphabetically by title

                // Render all lists that depend on `books` array
                renderBookList(); // For Catalogue
                renderAdminBookList(); // For Admin
                renderLeaderboard(); // For Leaderboard
                renderHomePageContent(); // For Home Page sections
            } catch (error) {
                console.error("Error fetching books from Supabase (catch block):", error);
                books = [];
            }
        }

        // --- Real-time Books Listener ---
        function setupRealtimeBooksListener() {
            if (!supabase) return;

            console.log("Setting up real-time books listener.");
            // Remove all existing channels to prevent multiple listeners
            supabase.removeAllChannels(); // This also unsubscribes 'profiles_changes' if it exists.
                                         // We need to re-subscribe it if necessary.
            setupRealtimeProfilesListener(); // Re-subscribe profiles listener

            supabase
                .channel('books_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'books' }, payload => {
                    console.log('Real-time book change received!', payload);
                    fetchAndRenderBooks(); // Re-fetch all books on any change
                })
                .subscribe();

            fetchAndRenderBooks(); // Initial fetch
        }

        // --- Fetch Book Details from Google Books API by ISBN ---
        async function fetchBookDetailsByIsbn() {
            const isbnSearchInput = document.getElementById('isbn-search-input').value.trim();
            if (!isbnSearchInput) {
                alert("Please enter an ISBN.");
                return;
            }

            const apiUrl = `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbnSearchInput}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    const volumeInfo = data.items[0].volumeInfo;
                    document.getElementById('book-title').value = volumeInfo.title || '';
                    document.getElementById('book-author').value = volumeInfo.authors ? volumeInfo.authors.join(', ') : '';
                    document.getElementById('book-isbn').value = isbnSearchInput;
                    alert("Book details fetched successfully!");
                } else {
                    alert("No book found for this ISBN. Please enter details manually.");
                    document.getElementById('book-title').value = '';
                    document.getElementById('book-author').value = '';
                    document.getElementById('book-isbn').value = isbnSearchInput;
                }
            } catch (error) {
                console.error("Error fetching book details:", error);
                alert("Error fetching book details. Please check the ISBN or your internet connection.");
                document.getElementById('book-title').value = '';
                document.getElementById('book-author').value = '';
                document.getElementById('book-isbn').value = isbnSearchInput;
            }
        }

        // --- Add/Update Book (Admin Function) ---
        async function handleAddUpdateBook(event) {
            event.preventDefault();

            const title = document.getElementById('book-title').value.trim();
            const author = document.getElementById('book-author').value.trim();
            const isbn = document.getElementById('book-isbn').value.trim();

            if (!title || !author) {
                alert("Book title and author cannot be empty.");
                return;
            }

            if (!supabase || !isAdmin) {
                alert("You are not authorized to add/update books.");
                return;
            }

            try {
                if (editingBook) {
                    const { data, error } = await supabase
                        .from('books')
                        .update({
                            title: title,
                            author: author,
                            isbn: isbn,
                            "last_modified": new Date().toISOString()
                        })
                        .eq('id', editingBook.id);

                    if (error) throw error;

                    alert("Book updated successfully!");
                    editingBook = null;
                    document.getElementById('add-edit-book-form').reset();
                    document.getElementById('add-edit-form-title').textContent = 'Add New Book';
                    document.getElementById('add-update-button').textContent = 'Add Book';
                    document.getElementById('cancel-edit-button').classList.add('hidden');
                    document.getElementById('isbn-search-section').classList.remove('hidden');
                } else {
                    const { data, error } = await supabase
                        .from('books')
                        .insert([
                            {
                                title: title,
                                author: author,
                                isbn: isbn,
                                "borrowed_by": null,
                                "added_by": userId
                            }
                        ]);

                    if (error) throw error;

                    alert("Book added successfully!");
                    document.getElementById('add-edit-book-form').reset();
                    document.getElementById('isbn-search-input').value = '';
                }
            } catch (e) {
                console.error("Error saving book: ", e);
                alert(`Error saving book: ${e.message}. Please check RLS policies and admin permissions.`);
            }
        }

        // --- Handle Edit Click (Admin Function) ---
        function handleEditClick(bookId) {
            editingBook = books.find(b => b.id === bookId);
            if (editingBook) {
                document.getElementById('book-title').value = editingBook.title;
                document.getElementById('book-author').value = editingBook.author;
                document.getElementById('book-isbn').value = editingBook.isbn || '';

                document.getElementById('add-edit-form-title').textContent = 'Edit Book Details';
                document.getElementById('add-update-button').textContent = 'Update Book';
                document.getElementById('cancel-edit-button').classList.remove('hidden');
                document.getElementById('isbn-search-section').classList.add('hidden');
                // Switch to admin tab
                switchTab('admin');
            }
        }

        // --- Handle Cancel Edit (Admin Function) ---
        function handleCancelEdit() {
            editingBook = null;
            document.getElementById('add-edit-book-form').reset();
            document.getElementById('add-edit-form-title').textContent = 'Add New Book';
            document.getElementById('add-update-button').textContent = 'Add Book';
            document.getElementById('cancel-edit-button').classList.add('hidden');
            document.getElementById('isbn-search-section').classList.remove('hidden');
        }

        // --- Handle Borrow/Return ---
        async function handleBorrowReturn(bookId, currentBorrowedByUid) {
            if (!supabase || !userId) {
                alert("You must be logged in to borrow or return books.");
                return;
            }

            let message = '';
            let newBorrowedByValue = null;

            if (currentBorrowedByUid && currentBorrowedByUid !== 'null') { // Book is currently borrowed
                if (currentBorrowedByUid === userId) { // Current user is the borrower
                    newBorrowedByValue = null; // Return the book
                    message = "Book returned successfully!";
                } else { // Book is borrowed by someone else
                    alert("This book is borrowed by another user. Only the borrower or an admin can return it.");
                    return;
                }
            } else { // Book is not borrowed
                newBorrowedByValue = userId; // Borrow the book
                message = `Book borrowed by you!`;
            }

            try {
                const { data, error } = await supabase
                    .from('books')
                    .update({
                        "borrowed_by": newBorrowedByValue,
                        "last_modified": new Date().toISOString()
                    })
                    .eq('id', bookId);

                if (error) throw error;
                alert(message);
            }
            // Use this catch block to provide user feedback
            catch (e) {
                console.error("Error updating borrow status: ", e);
                alert(`Error updating borrow status: ${e.message}. Please check RLS policies.`);
            }
        }

        // --- Handle Delete Book (Admin Function) ---
        async function handleDeleteBook(bookId) {
            if (!supabase) {
                alert("Supabase client not initialized. Please try again.");
                return;
            }

            if (!isAdmin) {
                alert("Only administrators can delete books.");
                return;
            }

            const confirmDelete = confirm("Are you sure you want to delete this book?");
            if (confirmDelete) {
                try {
                    const { error } = await supabase
                        .from('books')
                        .delete()
                        .eq('id', bookId);

                    if (error) throw error;
                    alert("Book deleted successfully!");
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    alert(`Error deleting book: ${e.message}. Please check RLS policies.`);
                }
            } else {
                alert("Delete action cancelled.");
            }
        }

        // --- Authentication Functions ---
        async function handleAuth(event, isSignUp) {
            event.preventDefault();
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();

            if (!email || !password) {
                alert("Email and password cannot be empty.");
                return;
            }

            if (!supabase) {
                alert("Supabase client not initialized. Please try again.");
                return;
            }

            try {
                let response;
                if (isSignUp) {
                    response = await supabase.auth.signUp({ email, password });
                    if (response.error) {
                        throw response.error;
                    }
                    if (response.data.user) {
                        alert("Sign up successful and logged in! You can now set your display name.");
                    } else {
                        alert("Sign up successful! Please check your email to confirm your account.");
                    }
                } else { // is login
                    response = await supabase.auth.signInWithPassword({ email, password });
                    if (response.error) {
                        throw response.error;
                    }
                    alert("Login successful!");
                }
                // onAuthStateChange listener will now handle renderMainAppContent() on success
            } catch (error) {
                console.error("Auth error:", error);
                alert(`Authentication failed: ${error.message}`);
            }
        }

        async function handleLogout() {
            if (!supabase) return;
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                alert("You have been logged out.");
                // Auth state change listener will handle view rendering
            } catch (error) {
                console.error("Logout error:", error);
                alert(`Logout failed: ${error.message}`);
            }
        }

        // --- Profile Management ---
        async function handleSetDisplayName(event) {
            event.preventDefault();
            const newDisplayName = document.getElementById('display-name-input').value.trim();
            const profileMessage = document.getElementById('profile-message');

            if (!newDisplayName) {
                profileMessage.textContent = "Display name cannot be empty.";
                profileMessage.classList.remove('text-green-600', 'text-red-600');
                profileMessage.classList.add('text-red-600');
                return;
            }
            if (!userId) {
                profileMessage.textContent = "You must be logged in to set a display name.";
                profileMessage.classList.remove('text-green-600', 'text-red-600');
                profileMessage.classList.add('text-red-600');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .upsert({ user_id: userId, display_name: newDisplayName }, { onConflict: 'user_id' })
                    .select();

                if (error) throw error;

                userProfiles[userId] = newDisplayName;
                profileMessage.textContent = "Display name updated successfully!";
                profileMessage.classList.remove('text-red-600');
                profileMessage.classList.add('text-green-600');
                updateUserInfoDisplay(); // Update header
                renderBookList(); // Update book list to show new name
                renderAdminBookList(); // Update admin list
                renderLeaderboard(); // Update leaderboard names
                renderHomePageContent(); // Update home page content with new display name
            } catch (error) {
                console.error("Error setting display name:", error);
                profileMessage.textContent = `Failed to set display name: ${error.message}`;
                profileMessage.classList.remove('text-green-600');
                profileMessage.classList.add('text-red-600');
            }
        }


        // --- View Rendering Logic (Tabs & Main/Auth views) ---
        function renderAuthView() {
            console.log("Rendering auth view...");
            initialLoadingScreen.style.display = 'none';
            if (mainContentDiv) mainContentDiv.classList.add('hidden');
            if (authViewDiv) authViewDiv.classList.remove('hidden');

            // Re-attach event listeners after innerHTML might have been replaced
            const authForm = document.getElementById('auth-form');
            const signInBtn = document.getElementById('signin-btn');
            const signUpBtn = document.getElementById('signup-btn');

            if (authForm) {
                // Remove existing listeners to prevent duplicates
                authForm.removeEventListener('submit', (e) => handleAuth(e, false));
                signInBtn.removeEventListener('click', (e) => handleAuth(e, false)); // Adjusted to match new HTML structure
                signUpBtn.removeEventListener('click', (e) => handleAuth(e, true));

                // Add new listeners
                authForm.addEventListener('submit', (e) => handleAuth(e, false)); // Sign In on form submit
                signInBtn.addEventListener('click', (e) => handleAuth(e, false)); // Redundant if form submit works, but good for clarity
                signUpBtn.addEventListener('click', (e) => handleAuth(e, true)); // Sign Up
            }
             console.log("Auth view rendered.");
        }

        function renderMainAppContent() {
            console.log("Rendering main app content...");
            initialLoadingScreen.style.display = 'none';
            if (authViewDiv) authViewDiv.classList.add('hidden');
            if (mainContentDiv) mainContentDiv.classList.remove('hidden');

            // Set initial tab to Home if no active tab or reload
            const currentActiveTab = document.querySelector('.tab-btn.tab-active');
            if (!currentActiveTab) {
                switchTab('home');
            }

            // Update admin tab visibility
            if (adminTab) { // Ensure adminTab element exists
                if (isAdmin) {
                    adminTab.classList.remove('hidden');
                } else {
                    adminTab.classList.add('hidden');
                    // If admin tab was active, switch to home
                    if (document.querySelector('.tab-btn.tab-active')?.dataset.tab === 'admin') {
                        switchTab('home');
                    }
                }
            }

            // Refresh content for current tab
            const activeTabName = document.querySelector('.tab-btn.tab-active')?.dataset.tab || 'home';
            if (activeTabName === 'catalogue') {
                renderBookList();
            } else if (activeTabName === 'admin') {
                renderAdminBookList();
            } else if (activeTabName === 'leaderboard') {
                renderLeaderboard();
            } else if (activeTabName === 'profile') {
                const displayNameInput = document.getElementById('display-name-input');
                if (displayNameInput) {
                     displayNameInput.value = userProfiles[userId] || userEmail || '';
                }
            } else if (activeTabName === 'home') {
                renderHomePageContent(); // Explicitly call for home page
            }
             console.log("Main app content rendered.");
        }

        // Function to switch tabs
        function switchTab(tabName) {
            tabs.forEach(t => t.classList.remove("tab-active"));
            panels.forEach(p => p.classList.add("hidden"));

            const targetTabBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
            const targetPanel = document.getElementById(tabName);

            if (targetTabBtn && targetPanel) {
                targetTabBtn.classList.add("tab-active");
                targetPanel.classList.remove("hidden");
                console.log(`Switched to tab: ${tabName}`);
                // Re-render content specific to the tab being activated
                if (tabName === 'catalogue') {
                    renderBookList();
                } else if (tabName === 'admin') {
                    renderAdminBookList();
                } else if (tabName === 'leaderboard') {
                    renderLeaderboard();
                } else if (tabName === 'profile') {
                    const displayNameInput = document.getElementById('display-name-input');
                    if (displayNameInput) {
                        displayNameInput.value = userProfiles[userId] || userEmail || '';
                    }
                    const profileMessage = document.getElementById('profile-message');
                    if (profileMessage) {
                         profileMessage.textContent = ''; // Clear message on tab switch
                    }
                } else if (tabName === 'home') {
                    renderHomePageContent();
                }
            } else {
                console.warn(`Attempted to switch to non-existent tab: ${tabName}`);
            }
        }

        function updateUserInfoDisplay() {
            const userInfoDiv = document.getElementById('user-info');
            if (userInfoDiv && userId) {
                const userDisplayName = userProfiles[userId] || userEmail || 'Guest';
                userInfoDiv.innerHTML = `
                    <p class="text-lg font-semibold text-gray-800">Hello, <span class="text-purple-700">${userDisplayName}</span>!</p>
                    ${isAdmin ? '<p class="text-sm text-gray-600">(Admin)</p>' : ''}
                `;
            } else if (userInfoDiv) {
                userInfoDiv.textContent = ''; // Clear on logout
            }
        }

        // --- Render Books List for Catalogue ---
        function renderBookList(booksToDisplay = books) {
            const booksListElement = document.getElementById('books-list');
            const noBooksMessage = document.getElementById('no-books-message');
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';


            if (!booksListElement) {
                console.warn("Books list element not found (catalogue). Skipping render.");
                return;
            }

            const filteredBooks = booksToDisplay.filter(book =>
                book.title.toLowerCase().includes(searchTerm) ||
                book.author.toLowerCase().includes(searchTerm) ||
                (book.isbn && book.isbn.toLowerCase().includes(searchTerm))
            );

            if (filteredBooks.length === 0) {
                booksListElement.innerHTML = '';
                if (noBooksMessage) noBooksMessage.classList.remove('hidden');
            } else {
                if (noBooksMessage) noBooksMessage.classList.add('hidden');
                booksListElement.innerHTML = filteredBooks.map(book => {
                    const isBorrowed = book.borrowed_by !== null;
                    const isBorrowedByCurrentUser = book.borrowed_by === userId;
                    const borrowerName = isBorrowed ? book.displayBorrowedBy : '';
                    const addedByName = book.displayAddedBy;

                    return `
                        <div class="book-list-item bg-gray-50 p-4 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center border border-gray-200">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">${book.title}</h3>
                                <p class="text-gray-600 text-sm">by ${book.author}</p>
                                <p class="text-gray-500 text-xs">Added by: ${addedByName}</p>
                                ${isBorrowed ?
                                    `<p class="text-sm text-yellow-700 mt-1">Borrowed by: ${borrowerName}</p>` :
                                    `<p class="text-sm text-green-700 mt-1">Available</p>`
                                }
                            </div>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-3 sm:mt-0">
                                ${isBorrowed ?
                                    (isBorrowedByCurrentUser ?
                                        `<button data-id="${book.id}" data-borrowed-by="${book.borrowed_by}" class="btn-green text-sm py-1 px-3 rounded-md borrow-return-btn">Return</button>` :
                                        `<button class="btn-yellow text-sm py-1 px-3 rounded-md opacity-75 cursor-not-allowed" disabled>Borrowed</button>`)
                                    :
                                    `<button data-id="${book.id}" data-borrowed-by="${book.borrowed_by}" class="btn-yellow text-sm py-1 px-3 rounded-md borrow-return-btn">Borrow</button>`
                                }
                            </div>
                        </div>
                    `;
                }).join('');

                // Attach borrow/return listeners for catalogue view
                document.querySelectorAll('#books-list .borrow-return-btn').forEach(button => {
                    button.addEventListener('click', () => handleBorrowReturn(button.dataset.id, button.dataset.borrowedBy));
                });
            }
        }

        // --- Render Books List for Admin Tab ---
        function renderAdminBookList() {
            const adminBookListElement = document.getElementById('admin-book-list');
            const noAdminBooksMessage = document.getElementById('no-admin-books-message');
            const adminSearchInput = document.getElementById('admin-search-input');
            const searchTerm = adminSearchInput ? adminSearchInput.value.toLowerCase() : '';

            if (!adminBookListElement || !isAdmin) {
                console.warn("Admin book list element not found or user not admin. Skipping render.");
                return;
            }

            const filteredBooks = books.filter(book =>
                book.title.toLowerCase().includes(searchTerm) ||
                book.author.toLowerCase().includes(searchTerm) ||
                (book.isbn && book.isbn.toLowerCase().includes(searchTerm))
            );

            if (filteredBooks.length === 0) {
                adminBookListElement.innerHTML = '';
                if (noAdminBooksMessage) noAdminBooksMessage.classList.remove('hidden');
            } else {
                if (noAdminBooksMessage) noAdminBooksMessage.classList.add('hidden');
                adminBookListElement.innerHTML = filteredBooks.map(book => {
                    const isBorrowed = book.borrowed_by !== null;
                    const borrowerName = isBorrowed ? book.displayBorrowedBy : '';
                    const addedByName = book.displayAddedBy;

                    return `
                        <div class="book-list-item bg-gray-50 p-4 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center border border-gray-200">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">${book.title}</h3>
                                <p class="text-gray-600 text-sm">by ${book.author}</p>
                                <p class="text-gray-500 text-xs">Added by: ${addedByName}</p>
                                ${isBorrowed ?
                                    `<p class="text-sm text-yellow-700 mt-1">Borrowed by: ${borrowerName}</p>` :
                                    `<p class="text-sm text-green-700 mt-1">Available</p>`
                                }
                            </div>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-3 sm:mt-0">
                                <button data-id="${book.id}" class="btn-blue text-sm py-1 px-3 rounded-md edit-btn">Edit</button>
                                <button data-id="${book.id}" class="btn-red text-sm py-1 px-3 rounded-md delete-btn">Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');

                // Attach action listeners for admin view
                document.querySelectorAll('#admin-book-list .edit-btn').forEach(button => {
                    button.addEventListener('click', () => handleEditClick(button.dataset.id));
                });
                document.querySelectorAll('#admin-book-list .delete-btn').forEach(button => {
                    button.addEventListener('click', () => handleDeleteBook(button.dataset.id));
                });
            }
        }

        // --- Render Leaderboard ---
        function renderLeaderboard() {
            const leaderboardList = document.getElementById('leaderboard-list');
            const noLeaderboardMessage = document.getElementById('no-leaderboard-data-message');

            if (!leaderboardList) {
                console.warn("Leaderboard list element not found. Skipping render.");
                return;
            }

            const borrowCounts = {};
            books.forEach(book => {
                if (book.borrowed_by) {
                    borrowCounts[book.borrowed_by] = (borrowCounts[book.borrowed_by] || 0) + 1;
                }
            });

            const sortedBorrowers = Object.entries(borrowCounts)
                .sort(([, countA], [, countB]) => countB - countA)
                .map(([userId, count]) => {
                    const displayName = userProfiles[userId] || userId; // Use display name from cache
                    return `<li>${displayName}: ${count} books</li>`;
                });

            if (sortedBorrowers.length === 0) {
                leaderboardList.innerHTML = '';
                if (noLeaderboardMessage) noLeaderboardMessage.classList.remove('hidden');
            } else {
                if (noLeaderboardMessage) noLeaderboardMessage.classList.add('hidden');
                leaderboardList.innerHTML = sortedBorrowers.join('');
            }
        }

        // --- NEW: Render Home Page Content ---
        function renderHomePageContent() {
            if (!userId) { // Only render if user is logged in
                console.log("Not logged in, skipping home page content render.");
                // Optionally clear home content if user logs out while on home tab
                const homeGreeting = document.getElementById('home-greeting');
                if (homeGreeting) homeGreeting.textContent = '';
                const borrowedBooksList = document.getElementById('your-borrowed-books-list');
                if (borrowedBooksList) borrowedBooksList.innerHTML = `<p class="text-gray-500" id="no-borrowed-books-message">You currently have no books borrowed.</p>`;
                const recentlyAddedBooksList = document.getElementById('recently-added-books-list');
                if (recentlyAddedBooksList) recentlyAddedBooksList.innerHTML = `<p class="text-gray-500" id="no-recent-books-message">No recently added books to display.</p>`;
                const statTotalBooks = document.getElementById('stat-total-books');
                if (statTotalBooks) statTotalBooks.textContent = '0';
                const statBorrowedBooks = document.getElementById('stat-borrowed-books');
                if (statBorrowedBooks) statBorrowedBooks.textContent = '0';
                const statAvailableBooks = document.getElementById('stat-available-books');
                if (statAvailableBooks) statAvailableBooks.textContent = '0';
                const statUniqueBorrowers = document.getElementById('stat-unique-borrowers');
                if (statUniqueBorrowers) statUniqueBorrowers.textContent = '0';
                return;
            }
            renderUserGreeting();
            renderUserBorrowedBooks();
            renderRecentlyAddedBooks();
            renderLibraryStatistics();
        }

        // --- NEW: Render User Greeting ---
        function renderUserGreeting() {
            const homeGreeting = document.getElementById('home-greeting');
            const userDisplayName = userProfiles[userId] || userEmail || 'Guest';
            if (homeGreeting) {
                homeGreeting.textContent = `Hello, ${userDisplayName}!`;
            }
        }

        // --- NEW: Render User Borrowed Books ---
        function renderUserBorrowedBooks() {
            const userBorrowedBooksList = document.getElementById('your-borrowed-books-list');
            const noBorrowedBooksMessage = document.getElementById('no-borrowed-books-message');

            if (!userBorrowedBooksList) return;

            const borrowedBooks = books.filter(book => book.borrowed_by === userId);

            if (borrowedBooks.length === 0) {
                userBorrowedBooksList.innerHTML = '';
                if (noBorrowedBooksMessage) noBorrowedBooksMessage.classList.remove('hidden');
            } else {
                if (noBorrowedBooksMessage) noBorrowedBooksMessage.classList.add('hidden');
                userBorrowedBooksList.innerHTML = borrowedBooks.map(book => `
                    <div class="book-list-item bg-gray-50 p-4 rounded-lg shadow-sm flex items-center justify-between border border-gray-200">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">${book.title}</h3>
                            <p class="text-gray-600 text-sm">by ${book.author}</p>
                        </div>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-3 sm:mt-0">
                            <button data-id="${book.id}" data-borrowed-by="${book.borrowed_by}" class="btn-green text-sm py-1 px-3 rounded-md borrow-return-btn">Return</button>
                        </div>
                    </div>
                `).join('');

                // Re-attach listeners for dynamically created buttons
                document.querySelectorAll('#your-borrowed-books-list .borrow-return-btn').forEach(button => {
                    button.addEventListener('click', () => handleBorrowReturn(button.dataset.id, button.dataset.borrowedBy));
                });
            }
        }

        // --- NEW: Render Recently Added Books ---
        function renderRecentlyAddedBooks() {
            const recentlyAddedBooksList = document.getElementById('recently-added-books-list');
            const noRecentBooksMessage = document.getElementById('no-recent-books-message');

            if (!recentlyAddedBooksList) return;

            // Sort by last_modified (most recent first) and take top 5
            const recentBooks = [...books] // Create a shallow copy to avoid modifying original array order
                .sort((a, b) => new Date(b.last_modified).getTime() - new Date(a.last_modified).getTime())
                .slice(0, 5); // Limit to 5 recent books

            if (recentBooks.length === 0) {
                recentlyAddedBooksList.innerHTML = '';
                if (noRecentBooksMessage) noRecentBooksMessage.classList.remove('hidden');
            } else {
                if (noRecentBooksMessage) noRecentBooksMessage.classList.add('hidden');
                recentlyAddedBooksList.innerHTML = recentBooks.map(book => `
                    <div class="book-list-item bg-gray-50 p-4 rounded-lg shadow-sm flex items-center justify-between border border-gray-200">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">${book.title}</h3>
                            <p class="text-gray-600 text-sm">by ${book.author}</p>
                            <p class="text-gray-500 text-xs">Added: ${new Date(book.last_modified).toLocaleDateString()}</p>
                        </div>
                    </div>
                `).join('');
            }
        }

        // --- NEW: Render Library Statistics ---
        function renderLibraryStatistics() {
            const totalBooksEl = document.getElementById('stat-total-books');
            const borrowedBooksEl = document.getElementById('stat-borrowed-books');
            const availableBooksEl = document.getElementById('stat-available-books');
            const uniqueBorrowersEl = document.getElementById('stat-unique-borrowers');

            if (!totalBooksEl || !borrowedBooksEl || !availableBooksEl || !uniqueBorrowersEl) return;

            const totalBooks = books.length;
            const borrowedCount = books.filter(book => book.borrowed_by !== null).length;
            const availableCount = totalBooks - borrowedCount;
            // Ensure uniqueBorrowers are counted from displayBorrowedBy if available, otherwise raw UIDs
            const uniqueBorrowers = new Set(books.map(book => book.borrowed_by).filter(Boolean)).size;


            totalBooksEl.textContent = totalBooks;
            borrowedBooksEl.textContent = borrowedCount;
            availableBooksEl.textContent = availableCount;
            uniqueBorrowersEl.textContent = uniqueBorrowers;
        }

        // --- Theme Toggling ---
        function toggleTheme() {
            const currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function applyTheme(theme) {
            const body = document.body;
            // Remove all specific theme classes first to ensure clean state
            body.classList.remove('light-mode', 'dark-mode');

            if (theme === 'dark') {
                body.classList.add('dark-mode');
            } else {
                body.classList.add('light-mode');
            }

            // Update theme toggle button text
            const themeToggleButton = document.getElementById('toggle-theme');
            if (themeToggleButton) {
                themeToggleButton.textContent = theme === 'light' ? 'Switch to Dark Mode' : 'Switch to Light Mode';
                // Adjust its background/text color classes directly
                if (theme === 'light') {
                    themeToggleButton.classList.remove('bg-gray-700', 'text-gray-200', 'hover:bg-gray-600');
                    themeToggleButton.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                } else {
                    themeToggleButton.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                    themeToggleButton.classList.add('bg-gray-700', 'text-gray-200', 'hover:bg-gray-600');
                }
            }
        }

        function getPreferredTheme() {
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme) {
                return storedTheme;
            }
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded fired.');
            applyTheme(getPreferredTheme()); // Apply theme as early as possible
            document.body.classList.add('transition-colors', 'duration-300'); // Enable transition after initial theme set

            // These listeners are on elements that are part of the main app content,
            // so they should be set up after mainContentDiv is rendered or its content is updated.
            // For now, these are fine here as they are globally defined elements that persist.
            const logoutButton = document.getElementById('logout-btn');
            if (logoutButton) {
                logoutButton.addEventListener('click', handleLogout);
            }

            const toggleThemeButton = document.getElementById('toggle-theme');
            if (toggleThemeButton) {
                toggleThemeButton.addEventListener('click', toggleTheme);
            }

            // Tab switching logic
            tabs.forEach(tab => {
                tab.addEventListener("click", () => {
                    switchTab(tab.dataset.tab);
                });
            });

            // Catalogue search input
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', () => renderBookList());
            }
            // Admin search input
            const adminSearchInput = document.getElementById('admin-search-input');
            if (adminSearchInput) {
                 adminSearchInput.addEventListener('input', () => renderAdminBookList());
            }

            // Admin Tab Specific Listeners
            const addEditBookForm = document.getElementById('add-edit-book-form');
            if (addEditBookForm) {
                addEditBookForm.addEventListener('submit', handleAddUpdateBook);
            }
            const fetchDetailsBtn = document.getElementById('fetch-details-btn');
            if (fetchDetailsBtn) {
                fetchDetailsBtn.addEventListener('click', fetchBookDetailsByIsbn);
            }
            const cancelEditButton = document.getElementById('cancel-edit-button');
            if (cancelEditButton) {
                cancelEditButton.addEventListener('click', handleCancelEdit);
            }

            // Profile Tab Listener
            const profileForm = document.getElementById('profile-form');
            if (profileForm) {
                profileForm.addEventListener('submit', handleSetDisplayName);
            }

            await initializeSupabase(); // Start the Supabase initialization process
        });
    </script>
</body>
</html>
